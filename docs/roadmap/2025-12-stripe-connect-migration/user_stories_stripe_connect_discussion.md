# Stripe Connect Migration - Requirements Discussion

**Project:** DONACTION  
**Epic:** Migration from Stripe Standard to Stripe Connect  
**Date:** 2025-12-03  
**Status:** Requirements Approved - Ready for Technical Planning

---

## Stripe Connect Account Type Recommendation

**Recommended: Express Accounts**

| Type | Pros | Cons | Recommendation |
|------|------|------|----------------|
| **Standard** | Association owns relationship with Stripe, full control | Associations leave Stripe ecosystem when offboarding, complex setup | ❌ Too complex for non-tech associations |
| **Express** | Stripe-hosted onboarding, DONACTION maintains relationship, simpler KYC | Less customization on onboarding UI | ✅ **BEST FIT** - Balance of simplicity + control |
| **Custom** | Full UI control, embedded experience | You handle all compliance/KYC UI, most development effort | ❌ Overkill for this use case |

**Why Express?**
- Stripe handles KYC UI (less dev work)
- DONACTION keeps control of relationship
- Associations don't need separate Stripe accounts
- Easy to monitor all accounts from platform
- Built-in compliance checks

---

## Approved Decisions for Open Questions

### 1. Idempotency for PaymentIntent Creation ✅
**Decision:** YES - Implement idempotency keys

**Implementation:**
- Generate unique idempotency key per donation attempt (e.g., `${donationId}-${timestamp}`)
- Store key in donation record
- Pass to Stripe API in `Idempotency-Key` header
- Prevents duplicate charges if donor double-clicks submit or network retry occurs

**Benefits:**
- Prevents accidental duplicate charges
- Safe retry mechanism for network failures
- Required for production payment systems

### 2. Audit Trail Depth ✅
**Decision:** Full log table implementation

**Justification:**
- Essential for debugging payment issues
- Compliance requirement (financial traceability)
- Helpful for fraud detection and dispute resolution
- Stripe Dashboard alone lacks donation context

### 3. Fee Justificatif (Proof Document) ✅
**Decision:** YES - Generate monthly fee statement for associations

**Purpose:**
- French accounting compliance
- Associations need proof of fees paid for their books
- Not an invoice (Stripe handles collection), but a "relevé de frais"

**Format:**
- PDF statement with:
  - Period covered
  - List of donations with fees
  - Total fees paid to DONACTION
  - Association details (SIREN, name, address)
  - Generated by admin or downloadable by association

### 4. Refund Edge Case with Tax Receipts ✅
**Decision:** Implement exceptional refund workflow with receipt cancellation

**Key Principles:**
1. **Immutability:** Never modify original tax receipt
2. **Cancellation Document:** Create separate "attestation d'annulation"
3. **Donor Engagement:** Require written declaration before refund
4. **Audit Trail:** Log all actions with timestamps and approvers

**See detailed workflow in:** `docs/roadmap/2025-12-stripe-connect-migration/refund-edge-case-tax-receipts.md`

---

## Refined Feature Requirements (Final Version)

### Project Context
- **Project Name:** DONACTION
- **Migration Type:** Fresh start (delete old donations, rebuild on Stripe Connect)
- **Scope:** EUR only, French residents, single-tenant (multi-tenant deferred)

---

### 1. Association Onboarding & Account Management

#### 1.1 Registration Flow (Next.js → Email → Angular)

**Next.js Registration Page:**
- Collect: Association name, address, email, password, sport type
- Create: User account + Klubr profile + **Stripe Express Account**
- Send: Email with activation link (contains token to auto-login + link to Angular)

**Email Link Behavior:**
- Auto-authenticate user in Angular Dashboard
- Connect user account to klubr profile
- Redirect to "Complete Your Profile" page

**Angular Dashboard Completion:**
- **Klub Info Page:** Complete all required fields (`requiredFieldsCompletion` → 100%)
- **Document Upload:** Upload required legal docs (`requiredDocsValidatedCompletion` → 100%)
  - Add new field: **`managerSignature`** (image upload) in `klubr` table for tax receipt signing
- **Stripe Connect KYC:** Link to continue Stripe Express onboarding (hosted by Stripe)
- **Manual Validation:** DONACTION admin validates docs (sets validation flag)
- **Page Activation:** Enable only when:
  - `klubr-info.requiredDocsValidatedCompletion === 100`
  - `klubr-info.requiredFieldsCompletion === 100`
  - Stripe Connect account status = `charges_enabled: true`


#### 1.2 Stripe Connect Integration (Backend - Strapi)

**New Content Type: `connected_account`**
- Relation to klubr (OneToOne)
- Stripe account ID, status, KYC requirements
- Onboarding link, last synced timestamp

**New Strapi Routes:**
- `POST /klubr/:id/stripe/create-account`
- `POST /klubr/:id/stripe/onboarding-link`
- `GET /klubr/:id/stripe/status`
- `POST /stripe/webhook`

**Required Webhooks:**
- `account.updated` - Sync KYC status
- `account.application.deauthorized` - Handle disconnection
- `payment_intent.succeeded` - Confirm donation
- `payment_intent.payment_failed` - Mark failed
- `charge.refunded` - Log warning (special workflow needed)

#### 1.3 Angular Dashboard Features

**New Screens:**
1. Payment Account Activation (`/payment-setup`)
2. Payment Account Status (`/payment-status`)
3. Trade Policy Configuration (`/trade-policy`) - 3 fee models + donor pays toggle
4. Enhanced Donation Dashboard (`/dons`)
5. Superadmin Monitoring (`/admin/connected-accounts`)
6. Fee Statement Generation (`/fee-statements`)
7. Exceptional Refund Management (`/refunds`)

---

### 2. Donation Flow (Svelte Web Component)

#### 2.1 Payment Creation with Idempotency

**Flow:**
1. Generate idempotency key client-side
2. Check for existing donation with key
3. Calculate fees based on trade policy
4. Create donation record FIRST
5. Create PaymentIntent with Stripe
6. Store PaymentIntent details in donation
7. Return clientSecret to Svelte

#### 2.2 Error Handling
- `account_inactive` → "Association temporarily unable to accept donations"
- `account_kyc_incomplete` → Gray out form with status message
- `payment_failed` → Retry button + cron backup

#### 2.3 Improved Retry
- Instant retry button on failed payment page
- Reuse clientSecret for 24 hours
- Cron job as backup only

---

### 3. Tax Receipt Generation

**Changes:**
- Use association details (not DONACTION)
- Include manager signature image
- Net or gross amount depending on `donorPayFee`
- Cerfa-compliant format

---

### 4. Database Schema Changes

**New Tables:**
- `connected_accounts` - Stripe account tracking
- `webhook_logs` - All webhook events
- `financial_audit_logs` - All financial events with actor, metadata
- `receipt_cancellations` - Refund workflow with donor declarations

**Modified Tables:**
- `klubrs` + `manager_signature` field
- `trade_policies` + fee_model, fixed_amount, donor_pays_fee
- `klub_dons` + idempotency_key, payment_intent_id, refund_status

---

### 5. Compliance & Legal

**GDPR:** Data processing agreement with Stripe in TOS  
**Cerfa:** Association name, SIREN, signature, amount, date  
**Accounting:** Monthly fee statements for associations  
**Audit Trail:** Full log table with all events  

---

### 6. Migration Strategy

1. Deploy to staging
2. Onboard 3-5 pilot associations
3. Email all existing associations
4. Go live with monitoring
5. Deprecate old flow

---

### 7. Testing Acceptance Criteria

✅ Association flow (registration → KYC → activation)  
✅ Donation flow with idempotency  
✅ Tax receipts with manager signature  
✅ Refund workflow with cancellation attestation  
✅ Superadmin monitoring and reports  
✅ Audit logs for all financial events  

---

### 8. Exceptional Refund Workflow

**Requirements if tax receipt exists:**
1. Signed donor declaration (won't use receipt)
2. OR original receipt returned
3. Justification (fraud, error, dispute, request)

**Approval workflow:**
- Association admin OR superadmin approval
- Generate cancellation attestation PDF
- Process Stripe refund
- Log in audit trail
- Notify tax authorities if needed (> threshold or fraud)

**Special cases:**
- Fraud → TRACFIN notification (> 10k€), block donor
- Legal dispute → Freeze until court decision
- Payment error → Fast-track if no receipt generated
- Retraction (14 days) → Simple cancellation

---

## Summary of Key Decisions

| Topic | Decision |
|-------|----------|
| **Stripe Account Type** | Express (Stripe-hosted onboarding) |
| **Fee Models** | 3 options: percentage, fixed+percentage, fixed only |
| **Fee Payment** | Configurable: deducted OR paid by donor |
| **Migration** | Fresh start (delete old donations) |
| **Activation Gates** | 100% fields + docs + Stripe KYC + manual validation |
| **Tax Receipt** | Association's name + manager signature |
| **Retry Mechanism** | Instant button + cron backup |
| **Idempotency** | ✅ Full implementation |
| **Audit Trail** | ✅ Full log table |
| **Fee Justificatif** | ✅ Monthly PDF statements |
| **Refund Process** | ✅ Exceptional workflow with cancellation |

---

## Next Steps

✅ **Requirements Approved - Ready for Technical Planning**

1. Generate detailed technical implementation plan using `/ide:03_plan/plan`
2. Break down into user stories with Gherkin acceptance criteria
3. Create GitHub issues with proper Epic linking
4. Estimate effort and prioritize stories
5. Begin Phase 1: Staging deployment

---

## Reference Documents

- Refund edge case: `docs/roadmap/2025-12-stripe-connect-migration/refund-edge-case-tax-receipts.md`
- Original epic: `docs/roadmap/from GPT/epic_migration_stripe_connect.md`
