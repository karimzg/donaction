name: Deploy to Staging

on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type DEPLOY to confirm deployment'
        required: true
        type: string
      apps:
        description: 'Apps to deploy (comma-separated: frontend,api,admin,saas or "all")'
        required: false
        default: 'all'
        type: string

concurrency:
  group: deploy-staging
  cancel-in-progress: false

permissions:
  contents: read
  packages: read

jobs:
  validate:
    name: Validate Deployment Request
    runs-on: ubuntu-latest
    outputs:
      deploy_frontend: ${{ steps.apps.outputs.frontend }}
      deploy_api: ${{ steps.apps.outputs.api }}
      deploy_admin: ${{ steps.apps.outputs.admin }}
      deploy_saas: ${{ steps.apps.outputs.saas }}
    steps:
      - name: Validate confirmation
        if: github.event.inputs.confirmation != 'DEPLOY'
        run: |
          echo "::error::Confirmation failed. You must type 'DEPLOY' to proceed."
          exit 1

      - name: Validate branch
        run: |
          BRANCH="${{ github.ref_name }}"
          if [[ ! "$BRANCH" =~ ^(demo/|release/|hotfix/) ]]; then
            echo "::error::Deployment only allowed from demo/*, release/*, or hotfix/* branches. Current: $BRANCH"
            exit 1
          fi
          echo "Branch validation passed: $BRANCH"

      - name: Determine apps to deploy
        id: apps
        run: |
          APPS="${{ github.event.inputs.apps }}"

          if [[ "$APPS" == "all" ]]; then
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "api=true" >> $GITHUB_OUTPUT
            echo "admin=true" >> $GITHUB_OUTPUT
            echo "saas=true" >> $GITHUB_OUTPUT
          else
            echo "frontend=$([[ "$APPS" == *"frontend"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "api=$([[ "$APPS" == *"api"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "admin=$([[ "$APPS" == *"admin"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "saas=$([[ "$APPS" == *"saas"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          fi

  deploy:
    name: Deploy to Staging Server
    runs-on: ubuntu-latest
    needs: validate
    environment: staging
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Create deployment directory
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            mkdir -p ~/donaction-staging/nginx
          EOF

      - name: Copy docker-compose.yml
        run: |
          scp -i ~/.ssh/id_rsa \
            infrastructure/staging/docker-compose.yml \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/donaction-staging/

      - name: Copy nginx configuration
        run: |
          scp -i ~/.ssh/id_rsa \
            infrastructure/staging/nginx/donaction.conf \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/donaction-staging/nginx/

      - name: Generate .env file on server
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOFSCRIPT'
            cat > ~/donaction-staging/.env << 'ENVEOF'
          # Auto-generated by GitHub Actions
          NODE_ENV=production
          ENVIRONMENT=re7

          # Database
          DATABASE_HOST=${{ secrets.DATABASE_HOST }}
          DATABASE_PORT=${{ secrets.DATABASE_PORT }}
          DATABASE_NAME=${{ secrets.DATABASE_NAME }}
          DATABASE_USERNAME=${{ secrets.DATABASE_USERNAME }}
          DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}

          # Strapi Authentication
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          ADMIN_JWT_SECRET=${{ secrets.ADMIN_JWT_SECRET }}
          APP_KEYS=${{ secrets.APP_KEYS }}
          API_TOKEN_SALT=${{ secrets.API_TOKEN_SALT }}
          TRANSFER_TOKEN_SALT=${{ secrets.TRANSFER_TOKEN_SALT }}

          # Stripe
          STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}
          STRIPE_WEBHOOK_SECRET_CONNECT=${{ secrets.STRIPE_WEBHOOK_SECRET_CONNECT }}

          # ImageKit
          IMAGEKIT_PUBLIC_KEY=${{ secrets.IMAGEKIT_PUBLIC_KEY }}
          IMAGEKIT_PRIVATE_KEY=${{ secrets.IMAGEKIT_PRIVATE_KEY }}
          IMAGEKIT_URL_ENDPOINT=${{ secrets.IMAGEKIT_URL_ENDPOINT }}

          # Email
          EMAIL_BREVO_API_KEY=${{ secrets.BREVO_API_KEY }}

          # Google Services
          GOOGLE_RECAPTCHA_SITE_KEY=${{ secrets.GOOGLE_RECAPTCHA_SITE_KEY }}

          # Application URLs
          NEXTAUTH_URL=${{ secrets.FRONT_URL }}
          KLUBR_UUID=${{ secrets.KLUBR_UUID }}
          ENVEOF
            chmod 600 ~/donaction-staging/.env
          EOFSCRIPT

      - name: Login to GHCR on server
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          EOF

      - name: Pull Docker images
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ~/donaction-staging
            echo "Pulling latest images from GHCR..."
            docker compose pull
            echo "Images pulled successfully"
          EOF

      - name: Deploy containers
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ~/donaction-staging

            echo "Stopping existing containers..."
            docker compose down --remove-orphans

            echo "Starting containers..."
            docker compose up -d

            echo "Cleaning up old images..."
            docker image prune -af --filter "until=24h"

            echo "Container status:"
            docker compose ps
          EOF

      - name: Install nginx configuration
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            # Copy nginx config to sites-available
            sudo cp ~/donaction-staging/nginx/donaction.conf \
                    /etc/nginx/sites-available/donaction-staging.conf

            # Create symlink if not exists
            sudo ln -sf /etc/nginx/sites-available/donaction-staging.conf \
                        /etc/nginx/sites-enabled/donaction-staging.conf

            # Test nginx configuration
            sudo nginx -t

            # Reload nginx
            sudo systemctl reload nginx

            echo "Nginx configuration updated and reloaded"
          EOF

      - name: Wait for services to start
        run: sleep 30

      - name: Health check
        id: health
        run: |
          echo "Performing health check on https://re7.donaction.fr/health..."

          MAX_RETRIES=5
          RETRY_DELAY=10

          for i in $(seq 1 $MAX_RETRIES); do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://re7.donaction.fr/health || echo "000")

            if [[ "$HTTP_STATUS" == "200" ]]; then
              echo "Health check passed! Status: $HTTP_STATUS"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "Attempt $i/$MAX_RETRIES - Status: $HTTP_STATUS. Retrying in ${RETRY_DELAY}s..."
            sleep $RETRY_DELAY
          done

          echo "Health check failed after $MAX_RETRIES attempts"
          echo "status=failure" >> $GITHUB_OUTPUT
          exit 1

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [validate, deploy]
    if: always()
    steps:
      - name: Determine status
        id: status
        run: |
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=:white_check_mark:" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
            echo "discord_color=3066993" >> $GITHUB_OUTPUT
            echo "title=Staging Deployment Successful" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=:x:" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
            echo "discord_color=15158332" >> $GITHUB_OUTPUT
            echo "title=Staging Deployment Failed" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        if: vars.SLACK_WEBHOOK_URL || secrets.SLACK_WEBHOOK_URL
        continue-on-error: true
        run: |
          WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"
          if [[ -z "$WEBHOOK_URL" ]]; then
            echo "Slack webhook not configured, skipping"
            exit 0
          fi

          curl -X POST "$WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "${{ steps.status.outputs.emoji }} ${{ steps.status.outputs.title }}",
              "attachments": [{
                "color": "${{ steps.status.outputs.color }}",
                "fields": [
                  {
                    "title": "Environment",
                    "value": "Staging (re7.donaction.fr)",
                    "short": true
                  },
                  {
                    "title": "Branch",
                    "value": "${{ github.ref_name }}",
                    "short": true
                  },
                  {
                    "title": "Deployed by",
                    "value": "${{ github.actor }}",
                    "short": true
                  },
                  {
                    "title": "Workflow",
                    "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>",
                    "short": true
                  }
                ]
              }]
            }'

      - name: Send Discord notification
        if: vars.DISCORD_WEBHOOK_URL || secrets.DISCORD_WEBHOOK_URL
        continue-on-error: true
        run: |
          WEBHOOK_URL="${{ secrets.DISCORD_WEBHOOK_URL }}"
          if [[ -z "$WEBHOOK_URL" ]]; then
            echo "Discord webhook not configured, skipping"
            exit 0
          fi

          curl -X POST "$WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d '{
              "embeds": [{
                "title": "${{ steps.status.outputs.title }}",
                "color": ${{ steps.status.outputs.discord_color }},
                "fields": [
                  {
                    "name": "Environment",
                    "value": "Staging (re7.donaction.fr)",
                    "inline": true
                  },
                  {
                    "name": "Branch",
                    "value": "${{ github.ref_name }}",
                    "inline": true
                  },
                  {
                    "name": "Deployed by",
                    "value": "${{ github.actor }}",
                    "inline": true
                  },
                  {
                    "name": "URLs",
                    "value": "[Frontend](https://re7.donaction.fr) | [API](https://re7.donaction.fr/service) | [Admin](https://re7.donaction.fr/admin)",
                    "inline": false
                  }
                ]
              }]
            }'
