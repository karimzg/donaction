name: Deploy to Staging

on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type DEPLOY to confirm deployment'
        required: true
        type: string
      apps:
        description: 'Apps to deploy (comma-separated: frontend,api,admin,saas or "all")'
        required: false
        default: 'all'
        type: string
      image_tag:
        description: 'Image tag to deploy (default: dev, or use sha-xxxxx for specific version)'
        required: false
        default: ''
        type: string

concurrency:
  group: deploy-staging
  cancel-in-progress: false

permissions:
  contents: read
  packages: read

env:
  STAGING_DOMAIN: re7.donaction.fr
  STAGING_ENV: re7
  IMAGE_REGISTRY: ghcr.io/${{ github.repository_owner }}
  SSH_PORT: 63009
  DEPLOY_DIR: ~/donaction-staging

jobs:
  validate:
    name: Validate Deployment Request
    runs-on: ubuntu-latest
    environment: staging
    outputs:
      deploy_frontend: ${{ steps.apps.outputs.frontend }}
      deploy_api: ${{ steps.apps.outputs.api }}
      deploy_admin: ${{ steps.apps.outputs.admin }}
      deploy_saas: ${{ steps.apps.outputs.saas }}
      services_list: ${{ steps.apps.outputs.services_list }}
      image_tag: ${{ steps.image.outputs.tag }}
    steps:
      - name: Validate confirmation
        if: github.event.inputs.confirmation != 'DEPLOY'
        run: |
          echo "::error::Confirmation failed. You must type 'DEPLOY' to proceed."
          exit 1

      - name: Determine image tag
        id: image
        run: |
          INPUT_TAG="${{ github.event.inputs.image_tag }}"
          if [[ -z "$INPUT_TAG" ]]; then
            echo "tag=dev" >> $GITHUB_OUTPUT
          else
            echo "tag=$INPUT_TAG" >> $GITHUB_OUTPUT
          fi

      - name: Validate branch
        run: |
          BRANCH="${{ github.ref_name }}"
          if [[ ! "$BRANCH" =~ ^(demo/|release/|hotfix/) ]]; then
            echo "::error::Deployment only allowed from demo/*, release/*, or hotfix/* branches. Current: $BRANCH"
            exit 1
          fi

      - name: Determine apps to deploy
        id: apps
        run: |
          APPS="${{ github.event.inputs.apps }}"
          SERVICES=""

          if [[ "$APPS" == "all" ]]; then
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "api=true" >> $GITHUB_OUTPUT
            echo "admin=true" >> $GITHUB_OUTPUT
            echo "saas=true" >> $GITHUB_OUTPUT
            SERVICES="frontend api admin saas"
          else
            [[ "$APPS" == *"frontend"* ]] && echo "frontend=true" >> $GITHUB_OUTPUT && SERVICES="$SERVICES frontend" || echo "frontend=false" >> $GITHUB_OUTPUT
            [[ "$APPS" == *"api"* ]] && echo "api=true" >> $GITHUB_OUTPUT && SERVICES="$SERVICES api" || echo "api=false" >> $GITHUB_OUTPUT
            [[ "$APPS" == *"admin"* ]] && echo "admin=true" >> $GITHUB_OUTPUT && SERVICES="$SERVICES admin" || echo "admin=false" >> $GITHUB_OUTPUT
            [[ "$APPS" == *"saas"* ]] && echo "saas=true" >> $GITHUB_OUTPUT && SERVICES="$SERVICES saas" || echo "saas=false" >> $GITHUB_OUTPUT
          fi

          echo "services_list=${SERVICES}" >> $GITHUB_OUTPUT

  deploy:
    name: Deploy to Staging Server
    runs-on: ubuntu-latest
    needs: validate
    environment: staging
    timeout-minutes: 15
    outputs:
      deployed_services: ${{ needs.validate.outputs.services_list }}
      deployment_time: ${{ steps.deploy.outputs.deployment_time }}
      service_status: ${{ steps.health.outputs.service-status }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: ./.github/actions/ssh-setup
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          ssh-host: ${{ vars.SSH_HOST }}
          ssh-user: ${{ vars.SSH_USER }}
          ssh-port: ${{ env.SSH_PORT }}

      - name: Validate secrets
        uses: ./.github/actions/validate-secrets
        with:
          secrets: |
            SSH_USER:${{ vars.SSH_USER }}
            SSH_HOST:${{ vars.SSH_HOST }}
            DATABASE_HOST:${{ vars.DATABASE_HOST }}
            DATABASE_NAME:${{ vars.DATABASE_NAME }}
            DATABASE_USERNAME:${{ secrets.DATABASE_USERNAME }}
            DATABASE_PASSWORD:${{ secrets.DATABASE_PASSWORD }}
            JWT_SECRET:${{ secrets.JWT_SECRET }}
            ADMIN_JWT_SECRET:${{ secrets.ADMIN_JWT_SECRET }}
            APP_KEYS:${{ secrets.APP_KEYS }}
            API_TOKEN_SALT:${{ secrets.API_TOKEN_SALT }}
            TRANSFER_TOKEN_SALT:${{ secrets.TRANSFER_TOKEN_SALT }}
            STRIPE_SECRET_KEY:${{ secrets.STRIPE_SECRET_KEY }}
            NEXTAUTH_SECRET:${{ secrets.NEXTAUTH_SECRET }}
            KLUBR_UUID:${{ vars.KLUBR_UUID }}
            EMAIL_SMTP_USER:${{ secrets.EMAIL_SMTP_USER }}
            EMAIL_SMTP_PASS:${{ secrets.EMAIL_SMTP_PASS }}
            ADMIN_EMAIL_BCC:${{ secrets.ADMIN_EMAIL_BCC }}

      - name: Validate Docker Compose v2
        run: |
          ssh -p ${{ env.SSH_PORT }} -i ~/.ssh/id_rsa ${{ vars.SSH_USER }}@${{ vars.SSH_HOST }} << 'EOF'
            if ! docker compose version --short 2>/dev/null | grep -qE '^2\.'; then
              echo "::error::Docker Compose v2 required"
              exit 1
            fi
          EOF

      - name: Create deployment directory
        run: |
          ssh -p ${{ env.SSH_PORT }} -i ~/.ssh/id_rsa ${{ vars.SSH_USER }}@${{ vars.SSH_HOST }} << 'EOF'
            mkdir -p ~/donaction-staging/{nginx,backups,logs,data/pgdata,data/private-pdf}
          EOF

      - name: Create GCC credentials file
        uses: ./.github/actions/gcc-credentials
        with:
          gcc-credentials: ${{ secrets.GOOGLE_GCC_CREDENTIALS }}
          ssh-user: ${{ vars.SSH_USER }}
          ssh-host: ${{ vars.SSH_HOST }}
          ssh-port: ${{ env.SSH_PORT }}
          deploy-dir: ${{ env.DEPLOY_DIR }}

      - name: Copy deployment files
        run: |
          scp -P ${{ env.SSH_PORT }} -i ~/.ssh/id_rsa \
            infrastructure/staging/docker-compose.yml \
            ${{ vars.SSH_USER }}@${{ vars.SSH_HOST }}:${{ env.DEPLOY_DIR }}/

          scp -P ${{ env.SSH_PORT }} -i ~/.ssh/id_rsa \
            infrastructure/staging/nginx/donaction.conf \
            ${{ vars.SSH_USER }}@${{ vars.SSH_HOST }}:${{ env.DEPLOY_DIR }}/nginx/

      - name: Generate and copy .env file
        run: |
          export DEPLOY_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          export GITHUB_REF_NAME="${{ github.ref_name }}"
          export GITHUB_SHA="${{ github.sha }}"
          export DOMAIN="${{ env.STAGING_DOMAIN }}"
          export DATABASE_HOST="${{ vars.DATABASE_HOST }}"
          export DATABASE_PORT="${{ vars.DATABASE_PORT }}"
          export DATABASE_NAME="${{ vars.DATABASE_NAME }}"
          export DATABASE_USERNAME="${{ secrets.DATABASE_USERNAME }}"
          export DATABASE_PASSWORD="${{ secrets.DATABASE_PASSWORD }}"
          export DATABASE_SSL="${{ vars.DATABASE_SSL }}"
          export JWT_SECRET="${{ secrets.JWT_SECRET }}"
          export ADMIN_JWT_SECRET="${{ secrets.ADMIN_JWT_SECRET }}"
          export APP_KEYS="${{ secrets.APP_KEYS }}"
          export API_TOKEN_SALT="${{ secrets.API_TOKEN_SALT }}"
          export TRANSFER_TOKEN_SALT="${{ secrets.TRANSFER_TOKEN_SALT }}"
          export STRIPE_SECRET_KEY="${{ secrets.STRIPE_SECRET_KEY }}"
          export STRIPE_WEBHOOK_SECRET="${{ secrets.STRIPE_WEBHOOK_SECRET }}"
          export STRIPE_WEBHOOK_SECRET_CONNECT="${{ secrets.STRIPE_WEBHOOK_SECRET_CONNECT }}"
          export IMAGEKIT_PUBLIC_KEY="${{ secrets.IMAGEKIT_PUBLIC_KEY }}"
          export IMAGEKIT_PRIVATE_KEY="${{ secrets.IMAGEKIT_PRIVATE_KEY }}"
          export IMAGEKIT_URL_ENDPOINT="${{ vars.IMAGEKIT_URL_ENDPOINT }}"
          export BREVO_API_KEY="${{ secrets.BREVO_API_KEY }}"
          export GOOGLE_RECAPTCHA_SITE_KEY="${{ secrets.GOOGLE_RECAPTCHA_SITE_KEY }}"
          export GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}"
          export GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}"
          export GOOGLE_MAPS_API_KEY="${{ secrets.GOOGLE_MAPS_API_KEY }}"
          export GOOGLE_GA_TRACKING_ID="${{ secrets.GOOGLE_GA_TRACKING_ID }}"
          export GOOGLE_PROJECT_NUMBER="${{ vars.GOOGLE_PROJECT_NUMBER }}"
          export GOOGLE_API_KEY_ID="${{ vars.GOOGLE_API_KEY_ID }}"
          export GOOGLE_PROJECT_ID="${{ vars.GOOGLE_PROJECT_ID }}"
          export FRONT_URL="${{ vars.FRONT_URL }}"
          export NEXTAUTH_SECRET="${{ secrets.NEXTAUTH_SECRET }}"
          export KLUBR_UUID="${{ vars.KLUBR_UUID }}"
          export STRAPI_FRONT_API_TOKEN="${{ secrets.STRAPI_FRONT_API_TOKEN }}"
          export STRIPE_PUBLIC_KEY="${{ secrets.STRIPE_PUBLIC_KEY }}"
          export VITE_ACTIVATE_ANALYTICS="${{ vars.VITE_ACTIVATE_ANALYTICS }}"
          export PLAUSIBLE_DATA_DOMAIN="${{ vars.PLAUSIBLE_DATA_DOMAIN }}"
          export EMAIL_SMTP_USER="${{ secrets.EMAIL_SMTP_USER }}"
          export EMAIL_SMTP_PASS="${{ secrets.EMAIL_SMTP_PASS }}"
          export ADMIN_EMAIL_BCC="${{ secrets.ADMIN_EMAIL_BCC }}"

          envsubst < .github/templates/env.staging.template > /tmp/.env.staging

          ENV_BASE64=$(cat /tmp/.env.staging | base64 -w 0)
          ssh -p ${{ env.SSH_PORT }} -i ~/.ssh/id_rsa ${{ vars.SSH_USER }}@${{ vars.SSH_HOST }} \
            "echo '$ENV_BASE64' | base64 -d > ${{ env.DEPLOY_DIR }}/.env && chmod 600 ${{ env.DEPLOY_DIR }}/.env"

      - name: Login to GHCR on server
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | ssh -p ${{ env.SSH_PORT }} -i ~/.ssh/id_rsa ${{ vars.SSH_USER }}@${{ vars.SSH_HOST }} \
            "docker login ghcr.io -u ${{ github.actor }} --password-stdin"

      - name: Deploy containers
        id: deploy
        uses: ./.github/actions/deploy-containers
        with:
          ssh-user: ${{ vars.SSH_USER }}
          ssh-host: ${{ vars.SSH_HOST }}
          ssh-port: ${{ env.SSH_PORT }}
          deploy-dir: ${{ env.DEPLOY_DIR }}
          services-list: ${{ needs.validate.outputs.services_list }}
          image-tag: ${{ needs.validate.outputs.image_tag }}
          image-registry: ${{ env.IMAGE_REGISTRY }}
          run-migrations: ${{ contains(needs.validate.outputs.services_list, 'api') || needs.validate.outputs.services_list == '' }}

      - name: Install and reload nginx
        run: |
          ssh -p ${{ env.SSH_PORT }} -i ~/.ssh/id_rsa ${{ vars.SSH_USER }}@${{ vars.SSH_HOST }} << 'EOF'
            sudo cp ~/donaction-staging/nginx/donaction.conf /etc/nginx/sites-available/donaction-staging.conf
            sudo ln -sf /etc/nginx/sites-available/donaction-staging.conf /etc/nginx/sites-enabled/
            sudo nginx -t && sudo systemctl reload nginx
          EOF

      - name: Health check
        id: health
        uses: ./.github/actions/health-check
        with:
          ssh-user: ${{ vars.SSH_USER }}
          ssh-host: ${{ vars.SSH_HOST }}
          ssh-port: ${{ env.SSH_PORT }}
          domain: ${{ env.STAGING_DOMAIN }}

      - name: Rollback on failure
        if: failure() && steps.deploy.outcome == 'success'
        uses: ./.github/actions/rollback
        with:
          ssh-user: ${{ vars.SSH_USER }}
          ssh-host: ${{ vars.SSH_HOST }}
          ssh-port: ${{ env.SSH_PORT }}
          deploy-dir: ${{ env.DEPLOY_DIR }}
          github-run-id: ${{ github.run_id }}

      - name: Notify rollback
        if: failure() && steps.deploy.outcome == 'success'
        uses: ./.github/actions/notify
        with:
          mode: rollback
          environment-name: Staging
          domain: ${{ env.STAGING_DOMAIN }}
          deployed-by: ${{ github.actor }}
          slack-webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          discord-webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          github-ref-name: ${{ github.ref_name }}
          github-sha: ${{ github.sha }}
          github-server-url: ${{ github.server_url }}
          github-repository: ${{ github.repository }}
          github-run-id: ${{ github.run_id }}

      - name: Cleanup old images
        if: success()
        uses: ./.github/actions/cleanup-images
        with:
          ssh-user: ${{ vars.SSH_USER }}
          ssh-host: ${{ vars.SSH_HOST }}
          ssh-port: ${{ env.SSH_PORT }}
          image-registry: ${{ env.IMAGE_REGISTRY }}

      - name: Logout from GHCR
        if: always()
        run: |
          ssh -p ${{ env.SSH_PORT }} -i ~/.ssh/id_rsa ${{ vars.SSH_USER }}@${{ vars.SSH_HOST }} "docker logout ghcr.io" 2>/dev/null || true

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/id_rsa

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [validate, deploy]
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Send notifications
        uses: ./.github/actions/notify
        with:
          mode: deploy
          status: ${{ needs.deploy.result }}
          environment-name: Staging
          domain: ${{ env.STAGING_DOMAIN }}
          services-deployed: ${{ needs.validate.outputs.services_list || 'all' }}
          service-status: ${{ needs.deploy.outputs.service_status }}
          deployed-by: ${{ github.actor }}
          slack-webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          discord-webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          github-ref-name: ${{ github.ref_name }}
          github-sha: ${{ github.sha }}
          github-server-url: ${{ github.server_url }}
          github-repository: ${{ github.repository }}
          github-run-id: ${{ github.run_id }}
