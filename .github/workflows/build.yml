name: Docker Build & Push

on:
  push:
    branches:
      - 'demo/**'
      - 'release/**'
      - 'hotfix/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  detect-changes:
    name: Detect Changed Apps
    runs-on: ubuntu-latest
    outputs:
      admin: ${{ steps.filter.outputs.admin }}
      frontend: ${{ steps.filter.outputs.frontend }}
      api: ${{ steps.filter.outputs.api }}
      saas: ${{ steps.filter.outputs.saas }}
      environment: ${{ steps.env.outputs.environment }}
      env_name: ${{ steps.env.outputs.env_name }}
      env_tag: ${{ steps.env.outputs.env_tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            admin:
              - 'donaction-admin/**'
            frontend:
              - 'donaction-frontend/**'
            api:
              - 'donaction-api/**'
            saas:
              - 'donaction-saas/**'

      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == refs/heads/demo/* ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "env_name=re7" >> $GITHUB_OUTPUT
            echo "env_tag=dev" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/heads/release/* ]] || [[ "${{ github.ref }}" == refs/heads/hotfix/* ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "env_name=prod" >> $GITHUB_OUTPUT
            echo "env_tag=prod" >> $GITHUB_OUTPUT
          else
            echo "::error::Unknown branch pattern: ${{ github.ref }}. Expected demo/*, release/*, or hotfix/*"
            exit 1
          fi

  # Manual approval gates - require reviewer approval before building
  approve-saas:
    name: Approve SaaS Build
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.saas == 'true'
    environment: approve-saas
    steps:
      - run: echo "‚úÖ SaaS build approved"

  approve-admin:
    name: Approve Admin Build
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.admin == 'true'
    environment: approve-admin
    steps:
      - run: echo "‚úÖ Admin build approved"

  approve-api:
    name: Approve API Build
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.api == 'true'
    environment: approve-api
    steps:
      - run: echo "‚úÖ API build approved"

  # Frontend approval only needed when SaaS wasn't changed
  # (if SaaS changed, SaaS approval already gates the flow)
  approve-frontend:
    name: Approve Frontend Build
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true' && needs.detect-changes.outputs.saas != 'true'
    environment: approve-frontend
    steps:
      - run: echo "‚úÖ Frontend build approved"

  # SaaS must build first - Frontend depends on its registry image
  build-saas:
    name: Build SaaS
    runs-on: ubuntu-latest
    needs: [detect-changes, approve-saas]
    environment: ${{ needs.detect-changes.outputs.environment }}
    timeout-minutes: 15
    if: always() && needs.detect-changes.outputs.saas == 'true' && needs.approve-saas.result == 'success'
    outputs:
      image_tag: ${{ steps.tags.outputs.env_tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine tags
        id: tags
        run: |
          ENV_TAG="${{ needs.detect-changes.outputs.env_tag }}"
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          TAGS="ghcr.io/karimzg/donaction-saas:${ENV_TAG},ghcr.io/karimzg/donaction-saas:sha-${SHORT_SHA}"

          BRANCH_NAME="${{ github.ref_name }}"
          if [[ "$BRANCH_NAME" =~ ^(release|hotfix)/(v[0-9]+\.[0-9]+\.[0-9]+.*)$ ]]; then
            VERSION="${BASH_REMATCH[2]}"
            TAGS="${TAGS},ghcr.io/karimzg/donaction-saas:${VERSION}"
          fi

          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "env_tag=${ENV_TAG}" >> $GITHUB_OUTPUT

      - name: Build and push SaaS
        uses: docker/build-push-action@v5
        with:
          context: .
          file: donaction-saas/docker/production/Dockerfile
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          build-args: |
            VITE_STRAPI_API_URL=${{ secrets.STRAPI_API_URL }}
            VITE_STRAPI_API_TOKEN=${{ secrets.STRAPI_FRONT_API_TOKEN }}
            VITE_STRIPE_PUBLISHABLE_KEY=${{ secrets.STRIPE_PUBLIC_KEY }}
            VITE_GOOGLE_RECAPTCHA_SITE_KEY=${{ secrets.GOOGLE_RECAPTCHA_SITE_KEY }}
            VITE_GOOGLE_MAPS_KEY=${{ secrets.GOOGLE_MAPS_API_KEY }}
            VITE_GOOGLE_GA_TRACKING_ID=${{ secrets.GOOGLE_GA_TRACKING_ID }}
            VITE_ACTIVATE_ANALYTICS=${{ secrets.VITE_ACTIVATE_ANALYTICS }}
            VITE_PLAUSIBLE_DATA_DOMAIN=${{ secrets.PLAUSIBLE_DATA_DOMAIN }}
            VITE_NEXT_URL=${{ secrets.FRONT_URL }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Output build summary
        run: |
          echo "‚úÖ Built and pushed SaaS"
          echo "üì¶ Image: ghcr.io/karimzg/donaction-saas"
          echo "üè∑Ô∏è  Tags: ${{ steps.tags.outputs.tags }}"

  # Frontend depends on SaaS registry image
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: [detect-changes, build-saas, approve-frontend]
    environment: ${{ needs.detect-changes.outputs.environment }}
    timeout-minutes: 30
    # Runs if:
    # - Frontend changed AND
    # - build-saas succeeded or was skipped AND
    # - approve-frontend succeeded or was skipped (skipped when SaaS changed)
    if: |
      always() &&
      needs.detect-changes.outputs.frontend == 'true' &&
      needs.detect-changes.result == 'success' &&
      (needs.build-saas.result == 'success' || needs.build-saas.result == 'skipped') &&
      (needs.approve-frontend.result == 'success' || needs.approve-frontend.result == 'skipped')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine tags
        id: tags
        run: |
          ENV_TAG="${{ needs.detect-changes.outputs.env_tag }}"
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          TAGS="ghcr.io/karimzg/donaction-frontend:${ENV_TAG},ghcr.io/karimzg/donaction-frontend:sha-${SHORT_SHA}"

          BRANCH_NAME="${{ github.ref_name }}"
          if [[ "$BRANCH_NAME" =~ ^(release|hotfix)/(v[0-9]+\.[0-9]+\.[0-9]+.*)$ ]]; then
            VERSION="${BASH_REMATCH[2]}"
            TAGS="${TAGS},ghcr.io/karimzg/donaction-frontend:${VERSION}"
          fi

          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "env_tag=${ENV_TAG}" >> $GITHUB_OUTPUT

      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: donaction-frontend/docker/production/Dockerfile
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          build-args: |
            NODE_ENV=production
            SAAS_VERSION=${{ needs.detect-changes.outputs.env_tag }}
            NEXT_PUBLIC_ENVIRONMENT=${{ needs.detect-changes.outputs.env_name }}
            NEXT_PUBLIC_SITE_URL=${{ secrets.FRONT_URL }}
            NEXT_PUBLIC_API_URL=${{ secrets.STRAPI_API_URL }}
            NEXT_PUBLIC_SERVER_COMPONENTS_DEV_API_URL=${{ secrets.STRAPI_API_URL }}
            NEXT_PUBLIC_STRAPI_API_TOKEN=${{ secrets.STRAPI_FRONT_API_TOKEN }}
            NEXT_PUBLIC_GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            NEXT_PUBLIC_GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            NEXT_PUBLIC_GOOGLE_RECAPTCHA_SITE_KEY=${{ secrets.GOOGLE_RECAPTCHA_SITE_KEY }}
            NEXT_PUBLIC_GOOGLE_MAPS_KEY=${{ secrets.GOOGLE_MAPS_API_KEY }}
            NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${{ secrets.STRIPE_PUBLIC_KEY }}
            NEXT_PUBLIC_ACTIVATE_ANALYTICS=${{ secrets.FRONT_ACTIVATE_ANALYTICS }}
            NEXT_PUBLIC_PLAUSIBLE_DATA_DOMAIN=${{ secrets.PLAUSIBLE_DATA_DOMAIN }}
            NEXT_PUBLIC_KLUBR_SPONSORSHIP_FORM_TOKEN=${{ secrets.FRONT_SPONSORSHIP_FORM_TOKEN }}
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Output build summary
        run: |
          echo "‚úÖ Built and pushed Frontend"
          echo "üì¶ Image: ghcr.io/karimzg/donaction-frontend"
          echo "üè∑Ô∏è  Tags: ${{ steps.tags.outputs.tags }}"

  # Admin build (requires approval)
  build-admin:
    name: Build Admin
    runs-on: ubuntu-latest
    needs: [detect-changes, approve-admin]
    environment: ${{ needs.detect-changes.outputs.environment }}
    timeout-minutes: 30
    if: always() && needs.detect-changes.outputs.admin == 'true' && needs.approve-admin.result == 'success'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine tags
        id: tags
        run: |
          ENV_TAG="${{ needs.detect-changes.outputs.env_tag }}"
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          TAGS="ghcr.io/karimzg/donaction-admin:${ENV_TAG},ghcr.io/karimzg/donaction-admin:sha-${SHORT_SHA}"

          BRANCH_NAME="${{ github.ref_name }}"
          if [[ "$BRANCH_NAME" =~ ^(release|hotfix)/(v[0-9]+\.[0-9]+\.[0-9]+.*)$ ]]; then
            VERSION="${BASH_REMATCH[2]}"
            TAGS="${TAGS},ghcr.io/karimzg/donaction-admin:${VERSION}"
          fi

          echo "tags=${TAGS}" >> $GITHUB_OUTPUT

      - name: Build and push Admin
        uses: docker/build-push-action@v5
        with:
          context: .
          file: donaction-admin/docker/production/Dockerfile
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          build-args: |
            ENVIRONMENT=${{ needs.detect-changes.outputs.env_name }}
            STRAPI_ADMIN_API_TOKEN=${{ secrets.STRAPI_ADMIN_API_TOKEN }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            GOOGLE_RECAPTCHA_SITE_KEY=${{ secrets.GOOGLE_RECAPTCHA_SITE_KEY }}
            GOOGLE_MAPS_API_KEY=${{ secrets.GOOGLE_MAPS_API_KEY }}
            KLUBR_UUID=${{ secrets.KLUBR_UUID }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Output build summary
        run: |
          echo "‚úÖ Built and pushed Admin"
          echo "üì¶ Image: ghcr.io/karimzg/donaction-admin"
          echo "üè∑Ô∏è  Tags: ${{ steps.tags.outputs.tags }}"

  # API build (requires approval)
  build-api:
    name: Build API
    runs-on: ubuntu-latest
    needs: [detect-changes, approve-api]
    environment: ${{ needs.detect-changes.outputs.environment }}
    timeout-minutes: 30
    if: always() && needs.detect-changes.outputs.api == 'true' && needs.approve-api.result == 'success'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine tags
        id: tags
        run: |
          ENV_TAG="${{ needs.detect-changes.outputs.env_tag }}"
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          TAGS="ghcr.io/karimzg/donaction-api:${ENV_TAG},ghcr.io/karimzg/donaction-api:sha-${SHORT_SHA}"

          BRANCH_NAME="${{ github.ref_name }}"
          if [[ "$BRANCH_NAME" =~ ^(release|hotfix)/(v[0-9]+\.[0-9]+\.[0-9]+.*)$ ]]; then
            VERSION="${BASH_REMATCH[2]}"
            TAGS="${TAGS},ghcr.io/karimzg/donaction-api:${VERSION}"
          fi

          echo "tags=${TAGS}" >> $GITHUB_OUTPUT

      - name: Build and push API
        uses: docker/build-push-action@v5
        with:
          context: .
          file: donaction-api/docker/production/Dockerfile
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          build-args: |
            NODE_ENV=production
            ENVIRONMENT=${{ needs.detect-changes.outputs.env_name }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Output build summary
        run: |
          echo "‚úÖ Built and pushed API"
          echo "üì¶ Image: ghcr.io/karimzg/donaction-api"
          echo "üè∑Ô∏è  Tags: ${{ steps.tags.outputs.tags }}"

  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [detect-changes, build-saas, build-frontend, build-admin, build-api]
    if: always()
    steps:
      - name: Determine build status
        id: status
        run: |
          # Check all build jobs - success if all succeeded or were skipped
          SAAS_OK=${{ needs.build-saas.result == 'success' || needs.build-saas.result == 'skipped' }}
          FRONTEND_OK=${{ needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped' }}
          ADMIN_OK=${{ needs.build-admin.result == 'success' || needs.build-admin.result == 'skipped' }}
          API_OK=${{ needs.build-api.result == 'success' || needs.build-api.result == 'skipped' }}

          if [[ "$SAAS_OK" == "true" && "$FRONTEND_OK" == "true" && "$ADMIN_OK" == "true" && "$API_OK" == "true" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
            echo "emoji=‚úÖ" >> $GITHUB_OUTPUT
            echo "discord_color=3066993" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
            echo "emoji=‚ùå" >> $GITHUB_OUTPUT
            echo "discord_color=15158332" >> $GITHUB_OUTPUT
          fi

      - name: Collect built apps
        id: apps
        run: |
          APPS=""
          if [[ "${{ needs.detect-changes.outputs.admin }}" == "true" ]]; then
            APPS="${APPS}admin, "
          fi
          if [[ "${{ needs.detect-changes.outputs.frontend }}" == "true" ]]; then
            APPS="${APPS}frontend, "
          fi
          if [[ "${{ needs.detect-changes.outputs.api }}" == "true" ]]; then
            APPS="${APPS}api, "
          fi
          if [[ "${{ needs.detect-changes.outputs.saas }}" == "true" ]]; then
            APPS="${APPS}saas, "
          fi

          # Remove trailing comma and space
          APPS=${APPS%, }

          if [[ -z "$APPS" ]]; then
            APPS="none (no changes detected)"
          fi

          echo "apps=${APPS}" >> $GITHUB_OUTPUT

      - name: Check notification configuration
        run: |
          if [[ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]]; then
            echo "‚ö†Ô∏è  SLACK_WEBHOOK_URL not configured - skipping Slack notification"
          fi
          if [[ -z "${{ secrets.DISCORD_WEBHOOK_URL }}" ]]; then
            echo "‚ö†Ô∏è  DISCORD_WEBHOOK_URL not configured - skipping Discord notification"
          fi

      - name: Send Slack notification
        continue-on-error: true
        run: |
          echo "üì§ Sending Slack notification..."
          RESPONSE=$(curl --silent -w "\n%{http_code}" -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "${{ steps.status.outputs.emoji }} Docker Build ${{ steps.status.outputs.status }}",
              "attachments": [{
                "color": "${{ steps.status.outputs.color }}",
                "fields": [
                  {
                    "title": "Branch",
                    "value": "${{ github.ref_name }}",
                    "short": true
                  },
                  {
                    "title": "Apps Built",
                    "value": "${{ steps.apps.outputs.apps }}",
                    "short": true
                  },
                  {
                    "title": "Commit",
                    "value": "<${{ github.event.head_commit.url }}|${{ github.sha }}>",
                    "short": true
                  },
                  {
                    "title": "Workflow",
                    "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>",
                    "short": true
                  }
                ]
              }]
            }')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [[ "$HTTP_CODE" == "200" ]]; then
            echo "‚úÖ Slack notification sent successfully"
          else
            echo "‚ùå Slack notification failed with HTTP code: $HTTP_CODE"
          fi

      - name: Send Discord notification
        continue-on-error: true
        run: |
          echo "üì§ Sending Discord notification..."
          RESPONSE=$(curl --silent -w "\n%{http_code}" -X POST ${{ secrets.DISCORD_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d '{
              "embeds": [{
                "title": "${{ steps.status.outputs.emoji }} Docker Build ${{ steps.status.outputs.status }}",
                "color": ${{ steps.status.outputs.discord_color }},
                "fields": [
                  {
                    "name": "Branch",
                    "value": "${{ github.ref_name }}",
                    "inline": true
                  },
                  {
                    "name": "Apps Built",
                    "value": "${{ steps.apps.outputs.apps }}",
                    "inline": true
                  },
                  {
                    "name": "Commit",
                    "value": "[${{ github.sha }}](${{ github.event.head_commit.url }})",
                    "inline": true
                  },
                  {
                    "name": "Workflow",
                    "value": "[View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})",
                    "inline": true
                  }
                ],
                "timestamp": "${{ github.event.head_commit.timestamp }}"
              }]
            }')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [[ "$HTTP_CODE" == "200" ]] || [[ "$HTTP_CODE" == "204" ]]; then
            echo "‚úÖ Discord notification sent successfully"
          else
            echo "‚ùå Discord notification failed with HTTP code: $HTTP_CODE"
          fi
