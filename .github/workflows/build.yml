name: Docker Build & Push

on:
  push:
    branches:
      - 'demo/**'
      - 'release/**'
      - 'hotfix/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  detect-changes:
    name: Detect Changed Apps
    runs-on: ubuntu-latest
    outputs:
      admin: ${{ steps.filter.outputs.admin }}
      frontend: ${{ steps.filter.outputs.frontend }}
      api: ${{ steps.filter.outputs.api }}
      saas: ${{ steps.filter.outputs.saas }}
      environment: ${{ steps.env.outputs.environment }}
      env_name: ${{ steps.env.outputs.env_name }}
      env_tag: ${{ steps.env.outputs.env_tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            admin:
              - 'donaction-admin/**'
            frontend:
              - 'donaction-frontend/**'
            api:
              - 'donaction-api/**'
            saas:
              - 'donaction-saas/**'

      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == refs/heads/demo/* ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "env_name=re7" >> $GITHUB_OUTPUT
            echo "env_tag=dev" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/heads/release/* ]] || [[ "${{ github.ref }}" == refs/heads/hotfix/* ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "env_name=prod" >> $GITHUB_OUTPUT
            echo "env_tag=prod" >> $GITHUB_OUTPUT
          else
            echo "::error::Unknown branch pattern: ${{ github.ref }}. Expected demo/*, release/*, or hotfix/*"
            exit 1
          fi

  # Manual approval gates
  approve-saas:
    name: Approve SaaS Build
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.saas == 'true'
    environment: approve-saas
    steps:
      - run: echo "✅ SaaS build approved"

  approve-admin:
    name: Approve Admin Build
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.admin == 'true'
    environment: approve-admin
    steps:
      - run: echo "✅ Admin build approved"

  approve-api:
    name: Approve API Build
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.api == 'true'
    environment: approve-api
    steps:
      - run: echo "✅ API build approved"

  approve-frontend:
    name: Approve Frontend Build
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true' && needs.detect-changes.outputs.saas != 'true'
    environment: approve-frontend
    steps:
      - run: echo "✅ Frontend build approved"

  # SaaS must build first - Frontend depends on its registry image
  build-saas:
    name: Build SaaS
    runs-on: ubuntu-latest
    needs: [detect-changes, approve-saas]
    environment: ${{ needs.detect-changes.outputs.environment }}
    timeout-minutes: 15
    if: always() && needs.detect-changes.outputs.saas == 'true' && needs.approve-saas.result == 'success'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build and push
        uses: ./.github/actions/docker-build-push
        with:
          app-name: saas
          dockerfile: donaction-saas/docker/production/Dockerfile
          env-tag: ${{ needs.detect-changes.outputs.env_tag }}
          env-name: ${{ needs.detect-changes.outputs.env_name }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          github-sha: ${{ github.sha }}
          github-ref-name: ${{ github.ref_name }}
          build-args: |
            VITE_STRAPI_API_URL=${{ vars.STRAPI_PUBLIC_URL }}
            VITE_STRAPI_API_TOKEN=${{ secrets.STRAPI_FRONT_API_TOKEN }}
            VITE_STRIPE_PUBLISHABLE_KEY=${{ secrets.STRIPE_PUBLIC_KEY }}
            VITE_GOOGLE_RECAPTCHA_SITE_KEY=${{ secrets.GOOGLE_RECAPTCHA_SITE_KEY }}
            VITE_GOOGLE_MAPS_KEY=${{ secrets.GOOGLE_MAPS_API_KEY }}
            VITE_GOOGLE_GA_TRACKING_ID=${{ secrets.GOOGLE_GA_TRACKING_ID }}
            VITE_ACTIVATE_ANALYTICS=${{ vars.VITE_ACTIVATE_ANALYTICS }}
            VITE_PLAUSIBLE_DATA_DOMAIN=${{ vars.PLAUSIBLE_DATA_DOMAIN }}
            VITE_NEXT_URL=${{ vars.FRONT_URL }}

  # Frontend depends on SaaS registry image
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: [detect-changes, build-saas, approve-frontend]
    environment: ${{ needs.detect-changes.outputs.environment }}
    timeout-minutes: 30
    if: |
      always() &&
      needs.detect-changes.outputs.frontend == 'true' &&
      needs.detect-changes.result == 'success' &&
      (needs.build-saas.result == 'success' || needs.build-saas.result == 'skipped') &&
      (needs.approve-frontend.result == 'success' || needs.approve-frontend.result == 'skipped')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build and push
        uses: ./.github/actions/docker-build-push
        with:
          app-name: frontend
          dockerfile: donaction-frontend/docker/production/Dockerfile
          env-tag: ${{ needs.detect-changes.outputs.env_tag }}
          env-name: ${{ needs.detect-changes.outputs.env_name }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          github-sha: ${{ github.sha }}
          github-ref-name: ${{ github.ref_name }}
          build-args: |
            NODE_ENV=production
            SAAS_VERSION=${{ needs.detect-changes.outputs.env_tag }}
            NEXT_PUBLIC_ENVIRONMENT=${{ needs.detect-changes.outputs.env_name }}
            NEXT_PUBLIC_SITE_URL=${{ vars.FRONT_URL }}
            NEXT_PUBLIC_API_URL=${{ vars.STRAPI_PUBLIC_URL }}
            NEXT_PUBLIC_SERVER_COMPONENTS_DEV_API_URL=${{ vars.STRAPI_PUBLIC_URL }}
            NEXT_PUBLIC_STRAPI_API_TOKEN=${{ secrets.STRAPI_FRONT_API_TOKEN }}
            NEXT_PUBLIC_GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            NEXT_PUBLIC_GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            NEXT_PUBLIC_GOOGLE_RECAPTCHA_SITE_KEY=${{ secrets.GOOGLE_RECAPTCHA_SITE_KEY }}
            NEXT_PUBLIC_GOOGLE_MAPS_KEY=${{ secrets.GOOGLE_MAPS_API_KEY }}
            NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${{ secrets.STRIPE_PUBLIC_KEY }}
            NEXT_PUBLIC_ACTIVATE_ANALYTICS=${{ vars.FRONT_ACTIVATE_ANALYTICS }}
            NEXT_PUBLIC_PLAUSIBLE_DATA_DOMAIN=${{ vars.PLAUSIBLE_DATA_DOMAIN }}
            NEXT_PUBLIC_KLUBR_SPONSORSHIP_FORM_TOKEN=${{ secrets.FRONT_SPONSORSHIP_FORM_TOKEN }}
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}

  build-admin:
    name: Build Admin
    runs-on: ubuntu-latest
    needs: [detect-changes, approve-admin]
    environment: ${{ needs.detect-changes.outputs.environment }}
    timeout-minutes: 30
    if: always() && needs.detect-changes.outputs.admin == 'true' && needs.approve-admin.result == 'success'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build and push
        uses: ./.github/actions/docker-build-push
        with:
          app-name: admin
          dockerfile: donaction-admin/docker/production/Dockerfile
          env-tag: ${{ needs.detect-changes.outputs.env_tag }}
          env-name: ${{ needs.detect-changes.outputs.env_name }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          github-sha: ${{ github.sha }}
          github-ref-name: ${{ github.ref_name }}
          build-args: |
            ENVIRONMENT=${{ needs.detect-changes.outputs.env_name }}
            STRAPI_ADMIN_API_TOKEN=${{ secrets.STRAPI_ADMIN_API_TOKEN }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            GOOGLE_RECAPTCHA_SITE_KEY=${{ secrets.GOOGLE_RECAPTCHA_SITE_KEY }}
            GOOGLE_MAPS_API_KEY=${{ secrets.GOOGLE_MAPS_API_KEY }}
            KLUBR_UUID=${{ vars.KLUBR_UUID }}

  build-api:
    name: Build API
    runs-on: ubuntu-latest
    needs: [detect-changes, approve-api]
    environment: ${{ needs.detect-changes.outputs.environment }}
    timeout-minutes: 30
    if: always() && needs.detect-changes.outputs.api == 'true' && needs.approve-api.result == 'success'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build and push
        uses: ./.github/actions/docker-build-push
        with:
          app-name: api
          dockerfile: donaction-api/docker/production/Dockerfile
          env-tag: ${{ needs.detect-changes.outputs.env_tag }}
          env-name: ${{ needs.detect-changes.outputs.env_name }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          github-sha: ${{ github.sha }}
          github-ref-name: ${{ github.ref_name }}
          build-args: |
            NODE_ENV=production
            ENVIRONMENT=${{ needs.detect-changes.outputs.env_name }}
            STRAPI_PUBLIC_URL=${{ vars.STRAPI_PUBLIC_URL }}

  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [detect-changes, build-saas, build-frontend, build-admin, build-api]
    if: always() && !cancelled()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Send notifications
        uses: ./.github/actions/notify
        with:
          saas-result: ${{ needs.build-saas.result }}
          frontend-result: ${{ needs.build-frontend.result }}
          admin-result: ${{ needs.build-admin.result }}
          api-result: ${{ needs.build-api.result }}
          saas-changed: ${{ needs.detect-changes.outputs.saas }}
          frontend-changed: ${{ needs.detect-changes.outputs.frontend }}
          admin-changed: ${{ needs.detect-changes.outputs.admin }}
          api-changed: ${{ needs.detect-changes.outputs.api }}
          slack-webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          discord-webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          github-ref-name: ${{ github.ref_name }}
          github-sha: ${{ github.sha }}
          github-server-url: ${{ github.server_url }}
          github-repository: ${{ github.repository }}
          github-run-id: ${{ github.run_id }}
          commit-url: ${{ github.event.head_commit.url }}
          commit-timestamp: ${{ github.event.head_commit.timestamp }}
