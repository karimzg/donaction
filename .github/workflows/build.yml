name: Docker Build & Push

on:
  push:
    branches:
      - 'demo/**'
      - 'release/**'
      - 'hotfix/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  detect-changes:
    name: Detect Changed Apps
    runs-on: ubuntu-latest
    outputs:
      admin: ${{ steps.filter.outputs.admin }}
      frontend: ${{ steps.filter.outputs.frontend }}
      api: ${{ steps.filter.outputs.api }}
      saas: ${{ steps.filter.outputs.saas }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            admin:
              - 'donaction-admin/**'
            frontend:
              - 'donaction-frontend/**'
            api:
              - 'donaction-api/**'
            saas:
              - 'donaction-saas/**'

  build:
    name: Build ${{ matrix.app }}
    runs-on: ubuntu-latest
    needs: detect-changes
    timeout-minutes: 30
    if: |
      needs.detect-changes.outputs.admin == 'true' ||
      needs.detect-changes.outputs.frontend == 'true' ||
      needs.detect-changes.outputs.api == 'true' ||
      needs.detect-changes.outputs.saas == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - app: admin
            context: .
            dockerfile: donaction-admin/docker/production/Dockerfile
            image: ghcr.io/karimzg/donaction-admin
            changed: ${{ needs.detect-changes.outputs.admin }}
          - app: frontend
            context: .
            dockerfile: donaction-frontend/docker/production/Dockerfile
            image: ghcr.io/karimzg/donaction-frontend
            changed: ${{ needs.detect-changes.outputs.frontend }}
          - app: api
            context: .
            dockerfile: donaction-api/docker/production/Dockerfile
            image: ghcr.io/karimzg/donaction-api
            changed: ${{ needs.detect-changes.outputs.api }}
          - app: saas
            context: .
            dockerfile: donaction-saas/docker/production/Dockerfile
            image: ghcr.io/karimzg/donaction-saas
            changed: ${{ needs.detect-changes.outputs.saas }}
    steps:
      - name: Skip if app not changed
        if: matrix.changed != 'true'
        run: echo "Skipping ${{ matrix.app }} - no changes detected"

      - name: Checkout repository
        if: matrix.changed == 'true'
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        if: matrix.changed == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        if: matrix.changed == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine tags
        if: matrix.changed == 'true'
        id: tags
        run: |
          # Determine environment tag based on branch
          if [[ "${{ github.ref }}" == refs/heads/demo/* ]]; then
            ENV_TAG="dev"
          elif [[ "${{ github.ref }}" == refs/heads/release/* ]] || [[ "${{ github.ref }}" == refs/heads/hotfix/* ]]; then
            ENV_TAG="prod"
          else
            ENV_TAG="dev"
          fi

          # Build tag list with short SHA (7 chars)
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          TAGS="${{ matrix.image }}:${ENV_TAG},${{ matrix.image }}:sha-${SHORT_SHA}"

          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "env_tag=${ENV_TAG}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        if: matrix.changed == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Output build summary
        if: matrix.changed == 'true'
        run: |
          echo "âœ… Built and pushed ${{ matrix.app }}"
          echo "ðŸ“¦ Image: ${{ matrix.image }}"
          echo "ðŸ·ï¸  Tags: ${{ steps.tags.outputs.tags }}"

  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: always()
    steps:
      - name: Determine build status
        id: status
        run: |
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
            echo "discord_color=3066993" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
            echo "discord_color=15158332" >> $GITHUB_OUTPUT
          fi

      - name: Collect built apps
        id: apps
        run: |
          APPS=""
          if [[ "${{ needs.detect-changes.outputs.admin }}" == "true" ]]; then
            APPS="${APPS}admin, "
          fi
          if [[ "${{ needs.detect-changes.outputs.frontend }}" == "true" ]]; then
            APPS="${APPS}frontend, "
          fi
          if [[ "${{ needs.detect-changes.outputs.api }}" == "true" ]]; then
            APPS="${APPS}api, "
          fi
          if [[ "${{ needs.detect-changes.outputs.saas }}" == "true" ]]; then
            APPS="${APPS}saas, "
          fi

          # Remove trailing comma and space
          APPS=${APPS%, }

          if [[ -z "$APPS" ]]; then
            APPS="none (no changes detected)"
          fi

          echo "apps=${APPS}" >> $GITHUB_OUTPUT

      - name: Send Slack notification
        if: secrets.SLACK_WEBHOOK_URL
        continue-on-error: true
        run: |
          curl --silent -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "${{ steps.status.outputs.emoji }} Docker Build ${{ steps.status.outputs.status }}",
              "attachments": [{
                "color": "${{ steps.status.outputs.color }}",
                "fields": [
                  {
                    "title": "Branch",
                    "value": "${{ github.ref_name }}",
                    "short": true
                  },
                  {
                    "title": "Apps Built",
                    "value": "${{ steps.apps.outputs.apps }}",
                    "short": true
                  },
                  {
                    "title": "Commit",
                    "value": "<${{ github.event.head_commit.url }}|${{ github.sha }}>",
                    "short": true
                  },
                  {
                    "title": "Workflow",
                    "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>",
                    "short": true
                  }
                ]
              }]
            }'

      - name: Send Discord notification
        if: secrets.DISCORD_WEBHOOK_URL
        continue-on-error: true
        run: |
          curl --silent -X POST ${{ secrets.DISCORD_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d '{
              "embeds": [{
                "title": "${{ steps.status.outputs.emoji }} Docker Build ${{ steps.status.outputs.status }}",
                "color": ${{ steps.status.outputs.discord_color }},
                "fields": [
                  {
                    "name": "Branch",
                    "value": "${{ github.ref_name }}",
                    "inline": true
                  },
                  {
                    "name": "Apps Built",
                    "value": "${{ steps.apps.outputs.apps }}",
                    "inline": true
                  },
                  {
                    "name": "Commit",
                    "value": "[${{ github.sha }}](${{ github.event.head_commit.url }})",
                    "inline": true
                  },
                  {
                    "name": "Workflow",
                    "value": "[View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})",
                    "inline": true
                  }
                ],
                "timestamp": "${{ github.event.head_commit.timestamp }}"
              }]
            }'
