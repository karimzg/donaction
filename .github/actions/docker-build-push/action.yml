name: 'Docker Build & Push'
description: 'Build and push Docker image to GitHub Container Registry'

inputs:
  app-name:
    description: 'Application name (e.g., saas, frontend, admin, api)'
    required: true
  dockerfile:
    description: 'Path to Dockerfile relative to repo root'
    required: true
  env-tag:
    description: 'Environment tag (dev, prod)'
    required: true
  env-name:
    description: 'Environment name (re7, prod)'
    required: true
  build-args:
    description: 'Docker build arguments (multiline)'
    required: false
    default: ''
  github-token:
    description: 'GitHub token for GHCR login'
    required: true
  github-sha:
    description: 'Git commit SHA'
    required: true
  github-ref-name:
    description: 'Git branch name'
    required: true

outputs:
  tags:
    description: 'Docker image tags'
    value: ${{ steps.tags.outputs.tags }}

runs:
  using: 'composite'
  steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ inputs.github-token }}

    - name: Determine tags
      id: tags
      shell: bash
      run: |
        ENV_TAG="${{ inputs.env-tag }}"
        SHORT_SHA=$(echo "${{ inputs.github-sha }}" | cut -c1-7)
        TAGS="ghcr.io/karimzg/donaction-${{ inputs.app-name }}:${ENV_TAG},ghcr.io/karimzg/donaction-${{ inputs.app-name }}:sha-${SHORT_SHA}"

        BRANCH_NAME="${{ inputs.github-ref-name }}"
        if [[ "$BRANCH_NAME" =~ ^(release|hotfix)/(v[0-9]+\.[0-9]+\.[0-9]+.*)$ ]]; then
          VERSION="${BASH_REMATCH[2]}"
          TAGS="${TAGS},ghcr.io/karimzg/donaction-${{ inputs.app-name }}:${VERSION}"
        fi

        echo "tags=${TAGS}" >> $GITHUB_OUTPUT

    - name: Build and push
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ${{ inputs.dockerfile }}
        push: true
        tags: ${{ steps.tags.outputs.tags }}
        build-args: ${{ inputs.build-args }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64
        labels: |
          org.opencontainers.image.environment=${{ inputs.env-name }}
          org.opencontainers.image.source.branch=${{ inputs.github-ref-name }}
          org.opencontainers.image.revision=${{ inputs.github-sha }}

    - name: Output build summary
      shell: bash
      run: |
        echo "âœ… Built and pushed ${{ inputs.app-name }}"
        echo "ğŸ“¦ Image: ghcr.io/karimzg/donaction-${{ inputs.app-name }}"
        echo "ğŸ·ï¸  Tags: ${{ steps.tags.outputs.tags }}"
