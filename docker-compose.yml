#version: '3'
services:

  donactionfrontend:
    container_name: ${PROJECT_SLUG}_frontend
    build:
      context: .
      dockerfile: ./donaction-frontend/docker/${ENVIRONMENT}/Dockerfile
      args:
        - NODE_ENV=${ENVIRONMENT}
    restart: unless-stopped
    networks:
      - internal
    volumes:
      - ./donaction-frontend:/app
      - donactionfrontend_node_modules:/app/node_modules
      - donactionfrontend-next:/app/.next
      - ./logs/donactionFrontend:/root/.npm/_logs
    env_file:
      - ./.env
    ports:
      - "3100:3000"
    depends_on:
      - donactionapi

  donactionadmin:
    container_name: ${PROJECT_SLUG}_admin
    build:
      context: .
      dockerfile: ./donaction-admin/docker/${ENVIRONMENT}/Dockerfile
      args:
        - NODE_ENV=${ENVIRONMENT}
    restart: unless-stopped
    networks:
      - internal
    volumes:
      - ./donaction-admin:/app:rw
      - donactionadmin_node_modules:/app/node_modules
      #      - donactionadmin-next:/app/.next
      - ./logs/donactionAdmin:/root/.npm/_logs
    #    env_file:
    #      - ./.env
    ports:
      - "4300:4200"
    depends_on:
      - donactionapi

  donactionapi:
    container_name: ${PROJECT_SLUG}_backend
    build:
      context: .
      dockerfile: ./donaction-api/docker/${ENVIRONMENT}/Dockerfile
      #dockerfile: ./donaction-api/docker/${ENVIRONMENT}/DockerfileTest
      args:
        - NODE_ENV=${ENVIRONMENT}
      no_cache: true
    tty: true
    restart: unless-stopped
    env_file: .env
    environment:
      #DATABASE_CLIENT: ${DATABASE_CLIENT}
      DATABASE_HOST: donaction_postgres_v5
      #DATABASE_NAME: ${DATABASE_NAME}
      #DATABASE_USERNAME: ${DATABASE_USERNAME}
      #DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      #DATABASE_PORT: ${DATABASE_PORT}
      #JWT_SECRET: ${JWT_SECRET}
      NODE_ENV: ${ENVIRONMENT}

    volumes:
      - ./donaction-api/src:/usr/src/app/src
      - donactionapi_node_modules:/usr/src/app/node_modules
      - ./logs/donactionApi:/root/.npm/_logs
      - ./donaction-api/config:/usr/src/app/config
      - ./donaction-api/data:/usr/src/app/data
      - ./donaction-api/database:/usr/src/app/database
      - ./donaction-api/package.json:/usr/src/app/package.json
      - ./donaction-api/package-lock.json:/usr/src/app/package-lock.json:rw # Replace with package-lock.json if using npm
      - ./donaction-api/.env.development:/usr/src/app/.env
      - ./donaction-api/private-pdf:/usr/src/app/private-pdf
    networks:
      - internal
    depends_on:
      - postgres
    ports:
      - "1437:1437"

  postgres:
    image: postgres:16.0-alpine
    container_name: ${PROJECT_SLUG}_postgres_v5
    platform: linux/amd64
    restart: unless-stopped
    env_file: .env
    environment:
      POSTGRES_USER: ${DATABASE_USERNAME}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
      POSTGRES_DB: ${DATABASE_NAME}
    ports:
      - "5532:5432"
    volumes:
      - donaction-postgres-data-v5:/var/lib/postgresql/data
    networks:
      - internal

  pgadmin:
    image: dpage/pgadmin4
    container_name: ${PROJECT_SLUG}_pgadmin4
    restart: unless-stopped
    ports:
      - "${PGADMIN_PORT:-5150}:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    networks:
      - internal
    volumes:
      - donaction-pgadmin-data:/var/lib/pgadmin
    # to run postgresql server on pgAdmin, get the network ip address of the postgresql container with the command:
    # docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' ${PROJECT_SLUG}_postgres_v5

volumes:
  donaction-postgres-data-v5:
  donaction-pgadmin-data:
  donactionfrontend-next:
  donactionfrontend_node_modules:
  donactionadmin_node_modules:
  donactionapi_node_modules:

networks:
  internal:
    name: ${PROJECT_SLUG}_internal
    driver: bridge
#    external: true
